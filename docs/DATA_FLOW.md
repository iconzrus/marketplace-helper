# Архитектура данных и потоки

## 📊 Обзор сущностей

### 1. **WbProduct** (Товары Wildberries)
- **Таблица БД**: `wb_product`
- **Источник**: Wildberries API (в реальном режиме) или генерация (в Mock режиме)
- **Используется в**: WB Каталог, Аналитика (для сопоставления)
- **Поля**: `nmId`, `name`, `brand`, `category`, `price`, `discount`, `totalQuantity`, и т.д.

### 2. **Product** (Товары из Excel/внутренние)
- **Таблица БД**: `product`
- **Источник**: Импорт из Excel, ручной ввод
- **Используется в**: Аналитика, Корректировки, Прайс-редактор
- **Поля**: `wbArticle`, `name`, `price`, `purchasePrice`, `logisticsCost`, `marketingCost`, и т.д.

---

## 🔄 Потоки данных

### Режим работы: **Mock Mode** (Тестовый кабинет)

```
┌─────────────────────────────────────────────────────────────┐
│  ГЕНЕРАЦИЯ MOCK КАБИНЕТА                                    │
│  Кнопка: "Сгенерировать кабинет (100–300 товаров)"         │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────┐
         │  DemoDataService.fillRandomAll()    │
         │  - Удаляет старые WbProduct         │
         │  - Генерирует 100-300 новых         │
         │  - Сохраняет в БД                   │
         │  - Генерирует продавца (ИП/ООО)     │
         └─────────────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────┐
         │  База данных: wb_product            │
         │  Содержит: 100-300 товаров          │
         └─────────────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────┐
         │  WB Каталог                         │
         │  GET /api/v2/list/goods/filter      │
         │  В Mock режиме ВСЕГДА берёт из БД   │
         │  (галочка "Локальные данные" скрыта)│
         └─────────────────────────────────────┘
```

### Режим работы: **Real Mode** (Реальный кабинет)

```
┌─────────────────────────────────────────────────────────────┐
│  СИНХРОНИЗАЦИЯ С WB API                                     │
│  Кнопка: "Синхронизировать с WB"                            │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────┐
         │  WbApiService.syncProductsFromWbApi │
         │  - Запрос к реальному WB API        │
         │  - Сохранение в БД (wb_product)     │
         └─────────────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────┐
         │  База данных: wb_product            │
         │  Содержит: реальные товары из WB    │
         └─────────────────────────────────────┘
                           │
                           ▼
         ┌─────────────────────────────────────┐
         │  WB Каталог                         │
         │  GET /api/v2/list/goods/filter      │
         │  useLocalData=true  → БД            │
         │  useLocalData=false → WB API        │
         └─────────────────────────────────────┘
```

---

## 🎯 Страницы и источники данных

### 1. **WB Каталог** (`/wb`)
- **Mock режим**: Всегда показывает данные из БД (`wb_product`)
- **Real режим**: 
  - `useLocalData=true` → БД (`wb_product`)
  - `useLocalData=false` → Прямой запрос к WB API
- **Кнопки**:
  - "Обновить товары" → перезагружает данные
  - "Синхронизировать с WB" → запрашивает WB API и сохраняет в БД

### 2. **Аналитика** (`/analytics`)
- **Источник**: `Product` (внутренние товары)
- **Сопоставление**: По `wbArticle` → `WbProduct.nmId`
- **Показывает**: 
  - Товары с полными данными (Product + WbProduct)
  - Товары требующие корректировки (только Product)
  - Товары требующие сопоставления (только WbProduct)

### 3. **Корректировки** (`/corrections`)
- **Источник**: `Product` (внутренние товары)
- **Показывает**: Товары с проблемами (низкая маржа, отсутствующие расходы)

### 4. **Прайс-редактор** (`/prices`)
- **Источник**: `Product` (внутренние товары)
- **Функция**: Редактирование цен и расходов

### 5. **Импорт** (`/import`)
- **Источник**: Excel файл
- **Результат**: Создание/обновление `Product`

### 6. **Демо-центр** (`/demo`)
- **Доступен**: Только в Mock режиме
- **Функции**:
  - Генерация mock кабинета (WbProduct)
  - Генерация дополнительных товаров (Product + WbProduct)
  - Автозаполнение расходов
  - Удаление товаров

---

## 🔧 Ключевые изменения (последний рефакторинг)

### Проблема (до):
1. В Mock режиме `useLocalData=false` возвращал статический JSON (14 товаров)
2. Сгенерированные 100-300 товаров не отображались в WB Каталоге
3. Запутанная логика переключения источников данных

### Решение (после):
1. ✅ В Mock режиме **всегда** используются данные из БД (игнорируется `useLocalData`)
2. ✅ Галочка "Использовать локальные данные" скрыта в Mock режиме
3. ✅ Сгенерированные товары сразу видны в WB Каталоге
4. ✅ Чёткое разделение: Mock → БД, Real → БД или API (по выбору)

### Код (WbProductController.java):
```java
// В Mock режиме ВСЕГДА используем локальные данные из БД
boolean useMock = wbApiService.isMockMode();

if (useMock || useLocalData) {
    // Используем локальные данные из базы
    List<WbProduct> products = getLocalProducts(...);
    return ResponseEntity.ok(products);
} else {
    // Получаем данные напрямую из WB API (только в реальном режиме)
    List<Map<String, Object>> wbProducts = wbApiService.getGoodsWithPricesFiltered(filters);
    return ResponseEntity.ok(wbProducts);
}
```

---

## 📝 Рекомендации для разработчиков

1. **Mock режим** → используйте для разработки без реального API
2. **Real режим** → используйте для работы с реальными данными WB
3. **Импорт Excel** → для добавления внутренних товаров с расходами
4. **Синхронизация WB** → для обновления цен и остатков из WB API
5. **Аналитика** → для сопоставления внутренних товаров с WB и расчёта маржи

---

## 🚨 Частые вопросы

**Q: Почему в WB Каталоге не видны сгенерированные товары?**  
A: Убедитесь, что вы в Mock режиме. Галочка "Использовать локальные данные" должна быть скрыта.

**Q: Почему в Аналитике товары "Требуют сопоставления"?**  
A: Это WbProduct без соответствующего Product. Нужно импортировать Excel или создать Product вручную.

**Q: Почему в Аналитике товары "Требуют корректировки"?**  
A: Это Product без соответствующего WbProduct. Нужно синхронизировать с WB или указать правильный `wbArticle`.

**Q: В чём разница между Product и WbProduct?**  
A: 
- **Product** → внутренние товары с расходами (закупка, логистика, маркетинг)
- **WbProduct** → товары из WB API (цена, скидка, остатки)
- **Аналитика** → сопоставляет их для расчёта маржи

