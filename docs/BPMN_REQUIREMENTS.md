# Требования BPMN «МВП доработан»

Ниже перечислены шаги бизнес-процесса, изображённого на схеме BPMN «МВП доработан». Схема разделена на два ключевых контура: слева располагается поток подготовки и обогащения товарных данных, справа — цикл проверки качества и исправления. Список составлен на основе анализа представленного диаграммы и использован для синхронизации репозитория с бизнес-логикой.

## Основной поток (левая ветка)

1. **Получение списка товаров из корпоративных систем** — стартовая задача, в которой менеджер выгружает исходные товарные позиции в Excel или БД.
2. **Формирование рабочей таблицы** — нормализация исходных данных (название, артикул WB, штрихкод, цены, остатки, издержки) и подготовка к дальнейшему обогащению.
3. **Запрос себестоимости и расходов** — обращение к внутренним источникам за данными о закупочной цене, логистике, маркетинге и прочих расходах.
4. **Импорт и синхронизация с кабинетом Wildberries** — обращение к API WB, получение карточек, сопоставление по артикулу/вендор-коду и сохранение в локальное хранилище.
5. **Расчёт маржи и процента маржинальности** — для каждой позиции высчитывается прибыль и % маржи с учётом всех затрат.
6. **Сортировка и фильтрация** — товары упорядочиваются по маржинальности, а неприбыльные или не проходящие порог DRP (минимальный % маржи) выводятся в отдельный список для проверки.
7. **Формирование отчёта** — итоговый набор товаров с положительной маржой готовится к выгрузке/передаче.
8. **Экспорт данных** — создание отчёта (например, CSV/Excel) только для позиций, которые удовлетворяют критериям маржинальности.

## Поток контроля качества (правая ветка)

1. **Первичная проверка полей** — валидация правильности цен (например, цена со скидкой не должна превышать базовую), заполненности всех затрат и допустимых значений.
2. **Выявление проблемных записей** — товары с ошибками, отрицательной маржей или маржой ниже порога помечаются как требующие корректировки.
3. **Коммуникация с менеджером** — система уведомляет пользователя о найденных несоответствиях, указывает причину и предлагает два варианта действий: «Исправить» или «Не исправлять».
4. **Ветка исправлений**:
   - Отображаются только проблемные позиции.
   - Менеджер корректирует данные и повторно запускает расчёт маржи.
   - Цикл продолжается до тех пор, пока все ошибки не устранены или пользователь не завершит процесс без корректировок.
5. **Завершение процесса** — после успешной ревизии формируется итоговый отчёт из прибыльных позиций; в противном случае фиксируется решение пользователя не вносить правки.

## Реализация в текущем репозитории

- Импорт Excel и нормализация данных реализованы в `ProductImportService` с учётом валидации полей и формирования отчёта о загрузке.
- Сопоставление с карточками WB, расчёт маржи и проверка бизнес-правил выполняются в `AnalyticsService`.
- Для аналитики добавлены сортировка, фильтрация по порогу маржи, разделение на «профитные» и «требующие корректировки» позиции, а также экспорт отчёта.
- UI подсвечивает товары, загруженные только из Excel (без данных WB), и выводит предупреждения о проблемах, повторяя логику ветки исправлений на схеме.
